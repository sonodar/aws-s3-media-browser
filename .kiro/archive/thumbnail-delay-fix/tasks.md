# Implementation Plan

セッション開始時に必ず `.kiro/steering/dev-rules.md` を読み込んでから作業してください。

## Task 1: 非推奨マーク

- [x] 1. 削除予定コンポーネントへの @deprecated マーク付与
  - `useUploadTracker` フックに `@deprecated` JSDoc コメントを追加し、Phase 3 完了後に削除予定であることを明記
  - `ThumbnailImage` コンポーネントに `@deprecated` JSDoc コメントを追加し、新規 `Thumbnail` コンポーネントに置き換え予定であることを明記
  - 置き換え先のコンポーネント・フック名を `@see` タグで参照できるよう記載
  - _Requirements: 3.5_

## Task 2: Storage Write 操作の useMutation 実装

- [x] 2.1 queryKeys にサムネイルキーを追加
  - `queryKeys.thumbnail(originalKey)` を追加し、サムネイル URL クエリの一意識別を可能にする
  - 既存の queryKeys パターン（型安全・as const）を踏襲
  - _Requirements: 2.2_

- [x] 2.2 (P) アップロード用 useMutation フックの実装
  - ファイルアップロードを実行する `useUploadMutation` フックを新規作成
  - `mutationKey: ["storage", "upload"]` で一意識別
  - `isPending` で処理中状態を提供
  - `onSuccess` で `invalidateQueries` を呼び出しファイル一覧を再取得
  - `isError` と `error` オブジェクトで失敗状態を提供
  - _Requirements: 1.1, 1.2, 1.7_

- [x] 2.3 (P) 削除用 useMutation フックの実装
  - ファイル/フォルダ削除を実行する `useDeleteMutation` フックを新規作成
  - `mutationKey: ["storage", "delete"]` で一意識別
  - `isPending` で処理中状態を提供
  - 複数アイテム削除と部分失敗の結果を返却
  - `onSuccess` で `invalidateQueries` を呼び出しファイル一覧を再取得
  - `isError` と `error` オブジェクトで失敗状態を提供
  - _Requirements: 1.3, 1.7_

- [x] 2.4 (P) 移動用 useMutation フックの実装
  - ファイル/フォルダ移動を実行する `useMoveMutation` フックを新規作成
  - `mutationKey: ["storage", "move"]` で一意識別
  - `isPending` で処理中状態を提供
  - 進捗コールバックをサポート
  - `onSuccess` で移動元・移動先両方のクエリを無効化
  - `isError` と `error` オブジェクトで失敗状態を提供
  - _Requirements: 1.4, 1.7_

- [x] 2.5 (P) リネーム用 useMutation フックの実装
  - ファイル/フォルダリネームを実行する `useRenameMutation` フックを新規作成
  - `mutationKey: ["storage", "rename"]` で一意識別
  - `isPending` で処理中状態を提供
  - フォルダ内コンテンツの再帰的リネームに対応
  - `onSuccess` で `invalidateQueries` を呼び出しファイル一覧を再取得
  - `isError` と `error` オブジェクトで失敗状態を提供
  - _Requirements: 1.5, 1.7_

- [x] 2.6 (P) フォルダ作成用 useMutation フックの実装
  - フォルダ作成を実行する `useCreateFolderMutation` フックを新規作成
  - `mutationKey: ["storage", "createFolder"]` で一意識別
  - `isPending` で処理中状態を提供
  - `onSuccess` で `invalidateQueries` を呼び出しファイル一覧を再取得
  - `isError` と `error` オブジェクトで失敗状態を提供
  - _Requirements: 1.6, 1.7_

## Task 3: サムネイル URL 取得の useQuery 実装

- [x] 3.1 サムネイル URL 取得用 useQuery フックの実装
  - サムネイル URL を取得する `useThumbnailUrl` フックを新規作成
  - `queryKey: ["thumbnail", originalKey]` で一意識別
  - `isLoading` でローディング状態を提供
  - `isError` で失敗状態を提供
  - `retry: 4` で最大 4 回のリトライを設定
  - `retryDelay` を指数バックオフ（1秒, 2秒, 4秒, 8秒）で設定
  - `staleTime: 5 * 60 * 1000` で 5 分間のキャッシュを設定
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 3.2 サムネイル表示用 Thumbnail コンポーネントの新規作成
  - `useThumbnailUrl` を使用してサムネイル URL を取得
  - ローディング中はスケルトン UI を表示
  - エラー時（リトライ超過）はフォールバックアイコンを表示
  - 成功時はサムネイル画像を表示
  - _Requirements: 2.3, 2.4_

## Task 4: 既存コンポーネントへの統合

- [x] 4.1 useStorageOperations の useMutation フック統合
  - 既存の `useStorageOperations` 内の各操作を対応する useMutation フックで置き換え
  - 手動の `useState` フラグ管理（`isDeleting` 等）を `isPending` に置き換え
  - 操作成功後の手動キャッシュ更新を `onSuccess` での `invalidateQueries` に置き換え
  - 既存の API インターフェースとの互換性を維持
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [x] 4.2 ThumbnailImage から Thumbnail への置き換え
  - `ThumbnailImage` を使用している箇所を新規 `Thumbnail` コンポーネントに置き換え
  - 既存のサムネイル表示機能が正しく動作することを確認
  - _Requirements: 3.5_

## Task 5: 互換性確認と最終検証

- [x] 5.1 既存機能の動作確認
  - ファイルアップロード機能（重複チェック含む）の動作確認
  - ファイル選択・複数選択・一括削除機能の動作確認
  - ファイル移動・リネーム・ダウンロード機能の動作確認
  - フォルダ作成・削除・リネーム機能の動作確認
  - アップロード中の進捗表示・キャンセル機能の動作確認
  - 操作中のローディング表示の動作確認
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.6, 3.7_

- [x] 5.2 サムネイルバグ解決の確認
  - アップロード直後のサムネイルがリトライにより自動表示されることを確認
  - サムネイル取得失敗時にフォールバックアイコンが表示されることを確認
  - 既存ファイルのサムネイルがキャッシュから即座に表示されることを確認
  - _Requirements: 2.3, 2.4, 2.5, 2.6, 3.5_

---

## Task 6: ユーザーテスト（リグレッションテスト）

### 影響範囲

| 変更対象                 | 影響するフック/コンポーネント                               | 影響する機能                                         |
| ------------------------ | ----------------------------------------------------------- | ---------------------------------------------------- |
| サムネイル表示           | `useThumbnailUrl`, `Thumbnail`                              | サムネイル表示、リトライ、フォールバック、キャッシュ |
| Storage Write 操作       | `useUploadMutation`, `useDeleteMutation`, `useMoveMutation` | ファイルアップロード、削除、移動                     |
| Storage Write 操作       | `useRenameMutation`, `useCreateFolderMutation`              | リネーム、フォルダ作成                               |
| useStorageOperations統合 | `useStorageOperations`                                      | 全 Storage 操作の状態管理                            |

### シナリオ 1: サムネイル表示（リトライ機構）

**1.1 アップロード直後のサムネイル表示**

1. [ ] 新しい画像ファイルをアップロード
2. [ ] アップロード完了後、ファイル一覧にサムネイルが表示される
   - 最初はスケルトン（ローディング）が表示される
   - Lambda によるサムネイル生成完了後、自動的にサムネイル画像が表示される
   - リトライ回数: 最大4回（1秒→2秒→4秒→8秒の指数バックオフ）

**1.2 既存ファイルのサムネイル表示（キャッシュ）**

1. [ ] フォルダ A を表示 → サムネイルが表示される
2. [ ] フォルダ B に移動 → フォルダ A に戻る
3. [ ] フォルダ A のサムネイルが即座に表示される（キャッシュから取得）

**1.3 サムネイル取得失敗時のフォールバック**

1. [ ] サムネイルが存在しないファイル（非対応形式など）を表示
2. [ ] リトライ後、フォールバックアイコン（ファイルタイプアイコン）が表示される

### シナリオ 2: ファイルアップロード

**2.1 単一ファイルアップロード**

1. [ ] アップロードボタンをクリック → ファイルを選択
2. [ ] アップロード中、進捗表示が表示される
3. [ ] アップロード完了後、一覧に新しいファイルが表示される（自動更新）
4. [ ] サムネイルがリトライ後に表示される

**2.2 重複ファイルアップロード**

1. [ ] 既存ファイルと同名のファイルをアップロード
2. [ ] ファイル名に (1) がついたファイルがアップロードされる
3. [ ] 一覧が自動更新される

**2.3 アップロードキャンセル**

1. [ ] アップロードを開始 → キャンセルボタンをクリック
2. [ ] アップロードが中断され、一覧に追加されない

### シナリオ 3: ファイル削除

**3.1 単一ファイル削除**

1. [ ] ファイルを長押し → コンテキストメニューから「削除」を選択
2. [ ] 確認ダイアログが表示される → 削除を確定
3. [ ] 削除中はローディング表示
4. [ ] 削除完了後、一覧からファイルが消える（自動更新）

**3.2 複数ファイル一括削除**

1. [ ] 選択モードで複数ファイルを選択
2. [ ] 削除ボタンをクリック → 確認ダイアログ → 削除を確定
3. [ ] 削除中はローディング表示
4. [ ] 削除完了後、選択モードが解除され、一覧から削除されたファイルが消える

### シナリオ 4: ファイル移動

**4.1 単一ファイル移動**

1. [ ] ファイルを長押し → コンテキストメニューから「移動」を選択
2. [ ] 移動先フォルダ選択ダイアログが表示される
3. [ ] 移動先フォルダを選択 → 移動を実行
4. [ ] 移動中は進捗表示
5. [ ] 移動完了後、現在のフォルダ一覧からファイルが消える（自動更新）

**4.2 複数ファイル一括移動**

1. [ ] 選択モードで複数ファイルを選択
2. [ ] 移動ボタンをクリック → 移動先フォルダを選択 → 移動を実行
3. [ ] 移動中は進捗表示
4. [ ] 移動完了後、選択モードが解除され、一覧からファイルが消える

### シナリオ 5: ファイルリネーム

**5.1 ファイルリネーム**

1. [ ] ファイルを長押し → コンテキストメニューから「名前を変更」を選択
2. [ ] リネームダイアログが表示される
3. [ ] 新しい名前を入力 → リネームを実行
4. [ ] リネーム完了後、一覧でファイル名が更新される（自動更新）

**5.2 フォルダリネーム（再帰的）**

1. [ ] フォルダを長押し → コンテキストメニューから「名前を変更」を選択
2. [ ] リネームダイアログが表示される
3. [ ] 新しい名前を入力 → リネームを実行
4. [ ] フォルダ内のすべてのファイル/サブフォルダも一緒にリネームされる
5. [ ] リネーム完了後、一覧でフォルダ名が更新される（自動更新）

### シナリオ 6: フォルダ作成

**6.1 フォルダ作成**

1. [ ] フォルダ作成ボタンをクリック
2. [ ] フォルダ名入力ダイアログが表示される
3. [ ] フォルダ名を入力 → 作成を実行
4. [ ] 作成完了後、一覧に新しいフォルダが表示される（自動更新）

### シナリオ 7: エラーハンドリング

**7.1 操作中のエラー**

1. [ ] オフライン状態でファイル操作（アップロード/削除/移動）を実行
2. [ ] エラーメッセージが表示される
3. [ ] オンラインに戻り、再試行で操作が成功する

---

## Requirements Coverage

| Requirement | Task Coverage                |
| ----------- | ---------------------------- |
| 1.1         | 2.2, 4.1                     |
| 1.2         | 2.2, 4.1                     |
| 1.3         | 2.3, 4.1                     |
| 1.4         | 2.4, 4.1                     |
| 1.5         | 2.5, 4.1                     |
| 1.6         | 2.6, 4.1                     |
| 1.7         | 2.2, 2.3, 2.4, 2.5, 2.6, 4.1 |
| 2.1         | 3.1                          |
| 2.2         | 2.1, 3.1                     |
| 2.3         | 3.1, 3.2, 5.2                |
| 2.4         | 3.1, 3.2, 5.2                |
| 2.5         | 3.1, 5.2                     |
| 2.6         | 3.1, 5.2                     |
| 3.1         | 5.1                          |
| 3.2         | 5.1                          |
| 3.3         | 5.1                          |
| 3.4         | 5.1                          |
| 3.5         | 1, 4.2, 5.2                  |
| 3.6         | 5.1                          |
| 3.7         | 5.1                          |
