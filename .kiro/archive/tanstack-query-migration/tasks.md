# Implementation Plan

セッション開始時に必ず `.kiro/steering/dev-rules.md` を読み込んでから作業してください。

## Tasks

### Phase 2-1: 基盤 + Auth

- [x] 1. TanStack Query 基盤の構築
- [x] 1.1 パッケージのインストールと QueryClient 設定
  - @tanstack/react-query と @tanstack/react-query-devtools をインストールする
  - デフォルトのキャッシュオプション（staleTime: 5分、gcTime: 30分、retry: 3、refetchOnWindowFocus: false）を定義する
  - 開発環境用の ReactQueryDevtools を設定する（本番ビルドから除外）
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 1.2 QueryProvider の作成と Provider 階層への統合
  - QueryClientProvider をラップする QueryProvider コンポーネントを作成する
  - JotaiProvider の内側に QueryProvider を配置する
  - TanStack Query（サーバー状態）と Jotai（クライアント状態）の責務分離を維持する
  - _Requirements: 1.1, 1.5_

- [x] 1.3 queryKeys ファクトリの作成
  - ドメインごとの queryKey パターンを定義する（identityId, items, folders, previewUrls, passkeys）
  - as const で型安全性を確保する
  - invalidateQueries でプレフィックスマッチが可能な構造にする
  - _Requirements: 2.2, 3.2, 4.2, 5.2, 6.1_

- [x] 2. 認証状態の TanStack Query 化
- [x] 2.1 useIdentityId フックの実装
  - useQuery で Cognito 認証セッションから Identity ID を取得する
  - staleTime: Infinity でセッション中のキャッシュを維持する
  - isLoading / isError で状態を返却する
  - _Requirements: 2.1, 2.2_

- [x] 2.2 既存の useIdentityId を置換
  - 既存の useState + useEffect パターンを useQuery ベースに置換する
  - 既存コードとの互換性のため同じインターフェース（identityId, loading, error）を維持
  - エラー時は isError でエラー状態を検出しエラー UI を表示する
  - _Requirements: 2.3, 2.4_

- [x] 3. パスキー管理の TanStack Query 化
- [x] 3.1 usePasskeyCredentials フックの実装
  - useQuery で WebAuthn クレデンシャル一覧を取得する
  - ページネーション（nextToken）を処理して全件取得する
  - 既存の toWebAuthnCredential 変換関数を再利用する
  - _Requirements: 6.1_

- [x] 3.2 (P) useRegisterPasskey フックの実装
  - useMutation で associateWebAuthnCredential を実行する
  - 成功時に invalidateQueries でクレデンシャル一覧を再取得する
  - isPending / isError で状態を返却する
  - _Requirements: 6.2_

- [x] 3.3 (P) useDeletePasskey フックの実装
  - useMutation で deleteWebAuthnCredential を実行する
  - 成功時に invalidateQueries でクレデンシャル一覧を再取得する
  - credentialId をパラメータとして受け取る
  - _Requirements: 6.3_

- [x] 3.4 既存の usePasskey を完全置換
  - usePasskeyCredentials, useRegisterPasskey, useDeletePasskey を統合するフックを作成する
  - PasskeySettings コンポーネントを新しいフックを使用するよう更新する
  - 既存のパスキー管理機能の動作を維持する
  - _Requirements: 6.4, 7.10_

### Phase 2-2: Storage Read

- [x] 4. ストレージ一覧取得の TanStack Query 化
- [x] 4.1 useStorageItems フックの実装
  - useQuery で現在のパスにあるファイル/フォルダ一覧を取得する
  - queryKey に identityId と currentPath を含める
  - enabled: !!identityId で identityId 取得まで待機する
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 4.2 useStorageOperations の Read 部分置換
  - 既存の fetchItems ロジック（useState + useEffect）を useStorageItems に置換する
  - ファイル操作後は invalidateQueries でファイル一覧を再取得する
  - Write 操作（upload, delete, move, rename, createFolder）は既存のまま維持する
  - _Requirements: 3.4, 3.5_

### Phase 2-3: Storage UI

- [x] 5. フォルダ選択の TanStack Query 化
- [x] 5.1 (P) useFolderList フックの実装
  - useQuery で指定パスのフォルダ一覧を取得する
  - queryKey に identityId と path を含める
  - フォルダのみをフィルタリングして返す（isFolder: true）
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 5.2 FolderBrowser コンポーネントの置換
  - 既存の useEffect + useState を useFolderList に置換する
  - MoveDialog が開いているときのみ enabled: true にする
  - ローディング中は isLoading でローディング UI を表示する
  - _Requirements: 4.4_

- [x] 6. プレビュー URL の TanStack Query 化
- [x] 6.1 (P) usePreviewUrls フックの実装
  - useQuery でプレビュー対象アイテムの署名付き URL を並列取得する
  - queryKey にアイテムキーを含める
  - Lightbox 用の Slide 配列を返す（画像/動画の type 変換含む）
  - staleTime: 10分（署名付き URL の有効期限を考慮）
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 6.2 PreviewModal コンポーネントの置換
  - 既存の useEffect + useState を usePreviewUrls に置換する
  - プレビューモーダルが開いているときのみ enabled: true にする
  - ローディング中は isLoading でローディング UI を表示する
  - _Requirements: 5.4_

### Phase 2-4: 互換性確認

- [x] 7. 既存機能の互換性確認とテスト
- [x] 7.1 コア機能の動作確認
  - ファイル/フォルダの一覧表示が正常に動作することを確認する
  - ファイルのアップロード（重複チェック含む）が正常に動作することを確認する
  - アップロード後に invalidateQueries でファイル一覧が更新されることを確認する
  - _Requirements: 7.1, 7.2_

- [x] 7.2 (P) 選択・削除機能の動作確認
  - ファイルの選択・複数選択が正常に動作することを確認する
  - 一括削除が正常に動作することを確認する
  - 削除後に invalidateQueries でファイル一覧が更新されることを確認する
  - _Requirements: 7.3_

- [x] 7.3 (P) 移動・リネーム・ダウンロード機能の動作確認
  - ファイルの移動が正常に動作することを確認する
  - ファイルのリネームが正常に動作することを確認する
  - ファイルのダウンロードが正常に動作することを確認する
  - 操作後に invalidateQueries でファイル一覧が更新されることを確認する
  - _Requirements: 7.4_

- [x] 7.4 (P) プレビュー・ナビゲーション機能の動作確認
  - サムネイル表示が正常に動作することを確認する
  - Lightbox によるメディアプレビューが正常に動作することを確認する
  - URL 同期によるフォルダナビゲーション（リロード・戻る/進む）が正常に動作することを確認する
  - _Requirements: 7.5, 7.6, 7.7_

- [x] 7.5 (P) ソート・ジェスチャー・パスキー機能の動作確認
  - ソート機能（設定永続化含む）が正常に動作することを確認する
  - ジェスチャー操作（長押し、スワイプ）が正常に動作することを確認する
  - パスキー管理機能が正常に動作することを確認する
  - _Requirements: 7.8, 7.9, 7.10_

- [x]\* 7.6 (P) 単体テストの作成
  - useIdentityId の単体テストを作成する（認証セッション取得のモック、エラー時の動作）
  - useStorageItems の単体テストを作成する（依存クエリの動作、リスト変換ロジック）
  - usePasskeyCredentials の単体テストを作成する（ページネーション処理、データ変換）
  - _Requirements: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 7.9, 7.10_

### Phase 2-5: ユーザーテスト

- [ ] 8. ユーザーテスト（リグレッションテスト）

#### 影響範囲

| 変更対象         | 影響するフック                                                    | 影響する機能                              |
| ---------------- | ----------------------------------------------------------------- | ----------------------------------------- |
| 認証状態管理     | `useIdentityId`                                                   | ログイン後の画面遷移、認証エラー表示      |
| ストレージ一覧   | `useStorageItems`                                                 | ファイル/フォルダ一覧表示、キャッシュ動作 |
| フォルダ選択     | `useFolderList`                                                   | 移動ダイアログでのフォルダツリー          |
| プレビューURL    | `usePreviewUrls`                                                  | Lightbox でのメディアプレビュー           |
| パスキー管理     | `usePasskeyCredentials`, `useRegisterPasskey`, `useDeletePasskey` | パスキー一覧・登録・削除                  |
| キャッシュ無効化 | `invalidateQueries`                                               | 操作後の一覧自動更新                      |

#### シナリオ 1: 認証とセッション管理

**1.1 ログイン後の画面遷移**

1. [x] ログアウト状態でアプリにアクセス
2. [x] ログイン画面が表示される
3. [x] 認証情報を入力してログイン
4. [x] ファイル一覧画面に遷移し、ルートフォルダの内容が表示される

**1.2 セッション維持**

1. [x] ログイン済み状態でブラウザをリロード
2. [x] 再認証なしでファイル一覧が表示される
3. [x] 別タブで同じアプリを開く
4. [x] 両タブで同じファイル一覧が表示される

#### シナリオ 2: ファイル/フォルダ一覧表示

**2.1 初期表示**

1. [x] ログイン後、ルートフォルダの内容が表示される
2. [x] ローディング表示が出た後、ファイル/フォルダ一覧が表示される
3. [x] フォルダが先、ファイルが後にソートされている

**2.2 フォルダナビゲーション**

1. [x] フォルダをクリック → URL が変更され、そのフォルダの内容が表示される
2. [x] ブラウザの戻るボタン → 前のフォルダに戻り、URL も復元される
3. [x] ブラウザの進むボタン → 再度そのフォルダに移動する

**2.3 一覧のキャッシュ動作**

1. [x] フォルダ A を表示 → フォルダ B に移動 → フォルダ A に戻る
2. [x] 再取得なしで即座にフォルダ A の内容が表示される（キャッシュ利用）

#### シナリオ 3: ファイルアップロード

**3.1 単一ファイルアップロード**

1. [x] アップロードボタンをクリック → ファイルを選択
2. [x] アップロード完了後、一覧に新しいファイルが表示される（自動更新）

**3.2 重複ファイルアップロード**

1. [x] 既存ファイルと同名のファイルをアップロード
2. [x] ファイル名に (1) がついたファイルがアップロードされる
3. [x] ファイルが更新され、一覧が更新される

#### シナリオ 4: ファイル選択と削除

**4.1 複数選択と一括削除**

1. [x] 複数のファイルを選択 → 選択数がアクションバーに表示される
2. [x] 削除ボタンをクリック → 確認ダイアログ → 削除を確定
3. [x] 削除完了後、一覧から削除されたファイルが消える（自動更新）

#### シナリオ 5: ファイル移動

**5.1 移動ダイアログとフォルダ選択**

1. [x] ファイルを選択し、移動ボタンをクリック
2. [x] 移動先フォルダ選択ダイアログが表示され、フォルダツリーが正しく表示される
3. [x] フォルダを展開 → サブフォルダが読み込まれて表示される
4. [x] 移動先フォルダを選択 → 移動を実行
5. [x] 移動完了後、現在のフォルダ一覧からファイルが消える（自動更新）

#### シナリオ 6: ファイルリネーム

**6.1 リネーム実行**

1. [x] ファイルを長押しし、名前を変更をクリック → リネームダイアログが表示
2. [x] 新しい名前を入力 → リネームを実行
3. [x] リネーム完了後、一覧でファイル名が更新される（自動更新）

#### シナリオ 7: メディアプレビュー

**7.1 画像プレビュー**

1. [x] 画像ファイルをクリック → Lightbox が開き、画像がプレビュー表示される
2. [x] 左右矢印で前後の画像に移動できる
3. [x] 左右スワイプで前後の画像に移動できる
4. [x] 閉じるボタンで Lightbox を閉じる
5. [x] 下スワイプで Lightbox を閉じる

**7.2 動画プレビュー**

1. [x] 動画ファイルをクリック → Lightbox が開き、動画プレーヤーが表示される
2. [x] 再生/一時停止が動作する

#### シナリオ 8: パスキー管理

**8.1 パスキー一覧表示**

1. [x] メニュー → 設定 をクリックしてパスキー設定モーダルを開く
2. [x] 登録済みパスキーの一覧が表示される（名前と作成日）

**8.2 パスキー登録**

1. [x] 「パスキーを登録」ボタンをクリック → ブラウザのパスキー認証ダイアログが表示
2. [x] 認証を完了 → 新しいパスキーが一覧に追加される（自動更新）

**8.3 パスキー削除**

1. [x] 削除したいパスキーの削除ボタンをクリック → 確認ダイアログ → 削除を確定
2. [x] パスキーが一覧から削除される（自動更新）

#### シナリオ 9: ソート機能

**9.1 ソート順変更と永続化**

1. [x] ソートボタンをクリック → ソートオプション（新しい順、古い順、名前順、サイズ順）が表示
2. [x] 「サイズ」を選択 → ファイル一覧がサイズ順に並び替わる
3. [x] ブラウザをリロード → 変更したソート順が維持されている

#### シナリオ 10: エラーハンドリング

**10.1 ネットワークエラー**

1. [x] オフライン状態でフォルダを開く → エラーメッセージが表示される
   - **🐛 BUG**: 「ファイルがありません」と表示される（エラーメッセージではない）
   - 原因: `useStorageItems.ts:41` で `query.data ?? []` としているため、エラー時も空配列を返す
   - → Task 9 で修正
2. [x] オンラインに戻る → 再試行またはリロードで一覧が表示される

---

## Task 9: エラー状態のハンドリング修正 ✅ COMPLETED

### 🐛 Bug Report (解決済み)

**問題**: オフライン状態でフォルダを開くと「ファイルがありません」と表示され、エラーメッセージが表示されない

**原因分析**:

- `useStorageItems.ts:41` で `const data = query.data ?? [];` としている
- `query.data` が `undefined` になる状況を区別していない：
  1. リクエスト成功・結果が空 → `[]` を返すべき ✅
  2. リクエスト失敗（エラー）→ `[]` を返すべきではない ❌
  3. リクエスト未実行（オフライン等）→ `[]` を返すべきではない ❌

**影響範囲**:

- `useStorageItems` フック
- 同様のパターンを使用している他のフック（要確認）

### Subtasks

- [x] **9.1**: `useStorageItems` のエラー状態ハンドリング修正
  - `query.data ?? []` を修正し、エラー時は `undefined` を返す
  - 戻り値の型を `StorageItem[] | undefined` に変更
- [x] **9.2**: `useFolderList` のエラー状態ハンドリング修正
  - 同様に `query.data ?? []` を修正
  - 戻り値の型を `StorageItem[] | undefined` に変更
- [x] **9.3**: `usePreviewUrls` のエラー状態ハンドリング修正
  - 同様に `data ?? []` を修正
  - 戻り値の型を `Slide[] | undefined` に変更
- [x] **9.4**: コンポーネント側でのエラー表示対応
  - `MediaBrowser` でエラー時に適切なメッセージを表示
  - 「ファイルがありません」と「エラーが発生しました」を区別
- [x] **9.5**: テストケースの追加
  - 各フックのエラー状態テスト（TDD で実施済み）
  - コンポーネントのエラー表示テスト（既存テスト更新で対応済み）

---

## Other Discovered Issues (Out of Scope)

以下は本タスク実行中に発見された、スコープ外のバグです。

| 発見日     | コンポーネント          | 問題                                  | 備考                           |
| ---------- | ----------------------- | ------------------------------------- | ------------------------------ |
| 2026-01-13 | `PasskeyManagement.tsx` | DeleteConfirmDialog が Mantine 未対応 | Mantine 対応タスク時の実装漏れ |

## Requirements Coverage

| Requirement | Tasks    |
| ----------- | -------- |
| 1.1         | 1.1, 1.2 |
| 1.2         | 1.1      |
| 1.3         | 1.1      |
| 1.4         | 1.1      |
| 1.5         | 1.2      |
| 2.1         | 2.1      |
| 2.2         | 1.3, 2.1 |
| 2.3         | 2.2      |
| 2.4         | 2.2      |
| 3.1         | 4.1      |
| 3.2         | 1.3, 4.1 |
| 3.3         | 4.1      |
| 3.4         | 4.2      |
| 3.5         | 4.2      |
| 4.1         | 5.1      |
| 4.2         | 1.3, 5.1 |
| 4.3         | 5.1      |
| 4.4         | 5.2      |
| 5.1         | 6.1      |
| 5.2         | 1.3, 6.1 |
| 5.3         | 6.1      |
| 5.4         | 6.2      |
| 6.1         | 1.3, 3.1 |
| 6.2         | 3.2      |
| 6.3         | 3.3      |
| 6.4         | 3.4      |
| 7.1         | 7.1      |
| 7.2         | 7.1      |
| 7.3         | 7.2      |
| 7.4         | 7.3      |
| 7.5         | 7.4      |
| 7.6         | 7.4      |
| 7.7         | 7.4      |
| 7.8         | 7.5      |
| 7.9         | 7.5      |
| 7.10        | 3.4, 7.5 |
