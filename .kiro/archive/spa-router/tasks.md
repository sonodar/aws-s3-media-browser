# Implementation Plan

## Tasks

- [x] 1. URL パース・同期ヘルパー関数の実装
- [x] 1.1 URL からパスを解析する関数を実装する
  - クエリパラメータ `path` から現在のフォルダパスを取得する
  - 日本語を含むパスを正しくデコードする
  - デコードエラー時はルートディレクトリにフォールバックする
  - _Requirements: 1.2, 3.1, 3.2, 3.4_

- [x] 1.2 パスを URL に同期する関数を実装する
  - 現在のパスをクエリパラメータとしてエンコードする
  - ルートディレクトリ時はパラメータを削除する
  - History API の pushState で URL を更新する
  - S3 キー形式（スラッシュ区切り）と互換性を維持する
  - _Requirements: 1.1, 1.4, 3.1, 3.3_

- [x] 2. useStorage フックの URL 同期機能追加
- [x] 2.1 初期化時に URL からパスを読み取る
  - useState の初期値を URL パース関数で取得する
  - ページリロード時に同じフォルダを表示できるようにする
  - _Requirements: 1.2, 1.3_

- [x] 2.2 パス変更時に URL を更新する
  - setCurrentPath のラッパー関数を作成する
  - パス更新と同時に URL 同期関数を呼び出す
  - navigate と goBack が URL を更新するようにする
  - _Requirements: 1.1, 1.3, 1.4_

- [x] 3. ブラウザナビゲーション対応
- [x] 3.1 ブラウザの戻る/進むボタンに対応する
  - popstate イベントリスナーを設定する
  - イベント発生時に URL からパスを再解析する
  - currentPath を更新して UI を同期させる
  - コンポーネントのアンマウント時にリスナーを解除する
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 4. 動作確認とテスト
- [x] 4.1 (P) URL 同期機能の単体テストを実装する
  - parseUrlPath の正常パス、空パス、日本語パス、不正エンコードのテスト
  - syncToUrl のパス反映、空パス時のパラメータ削除のテスト
  - _Requirements: 1.2, 3.1, 3.2, 3.4_

- [x] 4.2 (P) useStorage フックの URL 同期テストを実装する
  - URL からの初期値取得のテスト
  - navigate 時の URL 更新テスト
  - goBack 時の URL 更新テスト
  - popstate イベントでの状態更新テスト
  - _Requirements: 1.1, 1.3, 1.4, 2.1, 2.2, 2.3_

## Requirements Coverage

| Requirement | Tasks    |
| ----------- | -------- |
| 1.1         | 1.2, 2.2 |
| 1.2         | 1.1, 2.1 |
| 1.3         | 2.1, 2.2 |
| 1.4         | 1.2, 2.2 |
| 2.1         | 3.1      |
| 2.2         | 3.1      |
| 2.3         | 3.1      |
| 3.1         | 1.1, 1.2 |
| 3.2         | 1.1      |
| 3.3         | 1.2      |
| 3.4         | 1.1      |
