# Implementation Plan

## Task Overview

Jotai Atom ベースの状態管理基盤を構築し、共有状態（Selection, Path, Sort）を段階的に移行する。**禁止用途の useEffect を排除**し、データドリブン・アーキテクチャを実現する。

### 成功基準（Requirements より）

| 指標                             | 現状  | 目標  | 今回スコープ                          |
| -------------------------------- | ----- | ----- | ------------------------------------- |
| コンポーネント useEffect（禁止） | 2箇所 | 0箇所 | 2箇所排除（MoveDialog, RenameDialog） |
| hooks useEffect（禁止）          | 1箇所 | 0箇所 | 1箇所排除（useSelection）             |
| 派生値を状態として保持           | 多数  | 0     | Selection 関連を derived atoms 化     |
| Effect チェーン                  | 存在  | 0     | ダイアログ初期化を `key` 属性に置換   |

### 対象外（別 spec / Phase 2）

- Thumbnail ドメイン（ThumbnailImage.tsx 2箇所, useUploadTracker）→ 別 spec
- Server State（FolderBrowser, useStorageOperations, PreviewModal, useIdentityId）→ Phase 2

---

## Tasks

> **各タスク完了時の品質チェック**: `npm run check-all`

- [x] 1. Jotai 依存パッケージの導入と基盤設定

- [x] 1.1 (P) パッケージのインストールと型定義の確認
  - Jotai 2.x と jotai-devtools をプロジェクトに追加
  - TypeScript 型定義が正しく解決されることを確認
  - 既存の React 19 + Vite 環境との互換性を検証
  - _Requirements: 1.1, 1.3_

- [x] 1.2 DevTools Provider コンポーネントの作成
  - JotaiProvider ラッパーコンポーネントを実装
  - 開発モードでのみ Redux DevTools と連携する構成
  - 本番ビルドでは DevTools コードを除外
  - アプリケーションルートへの Provider 適用
  - _Requirements: 1.2, 6.1, 6.2, 6.3_

- [x] 1.3 テスト用ユーティリティの作成
  - TestProvider コンポーネントを実装（Vitest + Testing Library 対応）
  - useHydrateAtoms による初期状態注入機能
  - テスト間で atom 状態が独立することを検証
  - _Requirements: 7.1, 7.2, 7.3_

- [x] 2. 共有状態の Atom 定義

- [x] 2.1 (P) Selection Atoms の作成
  - 選択モード（boolean）の primitive atom を定義
  - 選択キー（Set）の primitive atom を atomWithReset で定義
  - 選択数の derived atom を定義（派生値を状態として保持しない原則）
  - isAllSelected の derived atom を定義（itemKeys との比較をレンダリング時計算）
  - toggleSelection, enterSelectionMode, exitSelectionMode, toggleSelectAll の action atom を定義
  - 各 atom に debugLabel を設定
  - _Requirements: 1.4, 2.3, 3.1, 3.2, 3.3_

- [x] 2.2 (P) Path Atoms の作成
  - 現在パス（string）の primitive atom を定義
  - pathSegments, parentPath の derived atoms を定義
  - navigate, goBack, setPath の action atoms を定義
  - 各 atom に debugLabel を設定
  - _Requirements: 1.4, 2.5_

- [x] 2.3 (P) Sort Atoms の作成
  - ソート順（'asc' | 'desc'）を atomWithStorage で定義
  - ソートキー（'name' | 'date' | 'size'）を atomWithStorage で定義
  - setSortOrder, setSortKey, toggleSortOrder の action atoms を定義
  - 各 atom に debugLabel を設定
  - _Requirements: 1.4_

- [x] 2.4 Atom 定義の単体テスト
  - Selection Atoms のトグル操作、モード切替、全選択をテスト
  - Path Atoms のナビゲート・戻る操作をテスト
  - Sort Atoms の順序変更・キー変更をテスト
  - TestProvider を使用した状態独立性を検証
  - _Requirements: 7.1, 7.2_

- [x] 3. 禁止用途 useEffect の排除と hooks 移行

- [x] 3.1 useSelection ファサードの実装と useEffect 排除
  - 既存の useSelection の戻り値型を完全維持
  - 内部実装を Selection Atoms に接続
  - useSelection.ts:41 の itemKeys 同期 useEffect を削除
  - itemKeys フィルタリングを derived atom に移行（禁止用途排除）
  - isAllSelected を derived atom から取得（レンダリング時計算）
  - 既存テストがパスすることを確認
  - _Requirements: 4.3, 5.1, 5.2, 5.3_

- [x] 3.2 useStoragePath ファサードの実装
  - 既存の useStoragePath の戻り値型を完全維持
  - 内部実装を Path Atoms に接続
  - URL クエリパラメータとの双方向同期を維持
  - popstate イベントリスナーは useEffect で維持（許可用途：ブラウザ API 同期）
  - 既存テストがパスすることを確認
  - _Requirements: 4.7, 5.1, 5.2, 5.3_

- [x] 3.3 useSort hook の実装
  - ソート設定と更新関数を返す hook を作成
  - Sort Atoms に接続し、既存の useSortOrder との互換性を維持
  - 既存テストがパスすることを確認
  - _Requirements: 4.8, 5.1, 5.2, 5.3_

- [x] 3.4 (P) MoveDialog の useEffect 排除
  - MoveDialog.tsx:50 の状態リセット useEffect を削除
  - `key` 属性による状態リセットに置換（禁止用途排除）
  - ダイアログを開くたびに新しい key を設定しコンポーネントを再マウント
  - 親コンポーネント（MediaBrowser）で dialogKey 状態を管理
  - 移動機能が正常に動作することを確認
  - _Requirements: 4.4_

- [x] 3.5 (P) RenameDialog の useEffect 排除
  - RenameDialog.tsx:49 の状態リセット useEffect を削除
  - `key` 属性による状態リセットに置換（禁止用途排除）
  - ダイアログを開くたびに新しい key を設定しコンポーネントを再マウント
  - 親コンポーネント（MediaBrowser）で dialogKey 状態を管理
  - リネーム機能が正常に動作することを確認
  - _Requirements: 4.4_

- [x] 3.6 ファサード hooks の統合テスト
  - 各ファサード hook が atom 経由で状態を共有することを検証
  - DevTools で状態変更が追跡できることを確認
  - debugLabel がアクション名として表示されることを確認
  - 禁止用途 useEffect が排除されていることを確認
  - _Requirements: 6.1, 6.2_

- [x] 4. MediaBrowser への統合と既存機能の検証

- [x] 4.1 MediaBrowser での atom 版 hooks 使用
  - MediaBrowser コンポーネントで atom 版 hooks を使用
  - ローカル UI 状態（ダイアログ表示、プレビューインデックス等）は useState のまま維持
  - ダイアログ key 管理を追加（MoveDialog, RenameDialog 用）
  - 選択・パス・ソート状態が正しく動作することを確認
  - _Requirements: 2.4, 3.1, 3.2, 3.3_

- [x] 4.2 既存機能の退行テスト
  - ファイル/フォルダ一覧表示が正常に動作
  - 選択・複数選択・一括削除が正常に動作
  - 移動機能が正常に動作（MoveDialog useEffect 排除後）
  - リネーム機能が正常に動作（RenameDialog useEffect 排除後）
  - ダウンロード機能が正常に動作
  - Lightbox プレビューが正常に動作
  - URL 同期によるフォルダナビゲーションが正常に動作
  - ソート機能（設定永続化含む）が正常に動作
  - ジェスチャー操作（長押し、スワイプ）が正常に動作
  - _Requirements: 4.1, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8, 4.9_

- [x] 4.3 useEffect 成功基準の検証
  - useSelection.ts の禁止用途 useEffect が 0 であることを確認
  - MoveDialog.tsx の禁止用途 useEffect が 0 であることを確認
  - RenameDialog.tsx の禁止用途 useEffect が 0 であることを確認
  - 許可用途 useEffect（popstate, クリックアウト等）のみ残存することを確認
  - DevTools で状態変更履歴が正しく記録されていることを確認
  - _Requirements: 成功基準（C1）_

- [x] 4.4 旧 hooks 実装の削除
  - ファサード移行が完了した hooks の旧実装を削除
  - 不要なインポートを整理
  - 全テストがパスすることを最終確認
  - _Requirements: 5.3_

---

## Requirements Coverage

| Requirement                 | Tasks               |
| --------------------------- | ------------------- |
| 1.1 グローバル状態管理      | 1.1                 |
| 1.2 DevTools 連携           | 1.2                 |
| 1.3 TypeScript 型安全性     | 1.1                 |
| 1.4 純粋関数ベース更新      | 2.1, 2.2, 2.3       |
| 2.3 選択状態                | 2.1                 |
| 2.4 UI 状態                 | 4.1 (useState 維持) |
| 2.5 パス状態                | 2.2                 |
| 3.1-3.3 props drilling 排除 | 2.1, 4.1            |
| 4.1-4.9 既存機能互換        | 4.2                 |
| 5.1-5.3 段階的移行          | 3.1, 3.2, 3.3, 4.4  |
| 6.1-6.3 デバッグ体験        | 1.2, 3.6            |
| 7.1-7.3 テスト容易性        | 1.3, 2.4            |

### Architecture Constraints Coverage

| Constraint | 内容                                                 | Tasks              |
| ---------- | ---------------------------------------------------- | ------------------ |
| C1         | useEffect 使用制限（禁止用途排除）                   | 3.1, 3.4, 3.5, 4.3 |
| C2         | Single Source of Truth（派生値は derived atoms）     | 2.1, 2.2           |
| C3         | コンポーネント設計原則（atoms 直接購読、`key` 属性） | 3.4, 3.5, 4.1      |
| C4         | 判断基準（ユーザー操作 → イベントハンドラ）          | 全タスク           |

### 対象外 Requirements（別 spec / Phase 2）

| Requirement                | Reason                          |
| -------------------------- | ------------------------------- |
| 2.1 ファイル一覧状態       | Server State（Phase 2）         |
| 2.2 サムネイル読み込み状態 | 別 spec（ThumbnailImage 2箇所） |
| 4.2 アップロード機能       | Thumbnail spec と合わせて対応   |

### 今回スコープ外の useEffect（許可用途で維持）

| ファイル                 | 用途                   | 理由                            |
| ------------------------ | ---------------------- | ------------------------------- |
| ContextMenu.tsx (2箇所)  | クリックアウト、Escape | DOM イベントリスナー            |
| DropdownMenu.tsx (2箇所) | クリックアウト、Escape | DOM イベントリスナー            |
| DeleteConfirmDialog.tsx  | フォーカス管理         | DOM 直接操作                    |
| useStoragePath.ts        | popstate リスナー      | ブラウザ API 同期               |
| useWebAuthnSupport.ts    | ブラウザ API 検出      | 外部システム同期                |
| useUploadTracker.ts      | サムネイル遅延表示     | 別 spec（Thumbnail）            |
| usePasskey.ts            | Cognito API 呼び出し   | 外部 API 同期（データフェッチ） |

---

## ユーザーテストシナリオ

> 以下のシナリオを手動で検証し、実装が正しく動作することを確認する。

### 既知の不具合（本 spec 対象外）

以下の不具合は長押しジェスチャー・コンテキストメニューの既存問題であり、本 spec（client-state-store）の対象外です。別途対応が必要です。

| 不具合                                                           | 備考                                       |
| ---------------------------------------------------------------- | ------------------------------------------ |
| フォルダ長押し後、ポインタをそのまま離すとフォルダ内に入る       | 横にスライドしてから離すと回避可能         |
| フォルダのコンテキストメニューで「削除」をタップしても動作しない | 選択モードからの削除は正常に動作           |
| iPhone でファイル長押しすると OS ネイティブメニューが表示される  | contextmenu イベントの抑制が必要と思われる |

### 1. 選択機能（Selection）

#### 1.1 選択モードの終了

| #   | 操作                               | 期待結果                                     | 結果 |
| --- | ---------------------------------- | -------------------------------------------- | ---- |
| 1   | 選択モード中に「×」ボタンをタップ  | 選択モードが終了し、選択がすべてクリアされる | ✅   |
| 2   | 選択モード中にブラウザの戻るボタン | 選択モードのまま、選択がすべてクリアされる   | ✅   |

#### 1.2 アイテムの選択・解除

| #   | 操作                           | 期待結果                                 | 結果 |
| --- | ------------------------------ | ---------------------------------------- | ---- |
| 1   | 選択モード中にアイテムをタップ | 未選択なら選択、選択済みなら解除         | ✅   |
| 2   | 複数アイテムを順にタップ       | 各アイテムが独立して選択/解除される      | ✅   |
| 3   | 選択数表示                     | ヘッダーに現在の選択数が正しく表示される | ✅   |

#### 1.3 全選択・全解除

| #   | 操作                                               | 期待結果                     | 結果 |
| --- | -------------------------------------------------- | ---------------------------- | ---- |
| 1   | 「全選択」ボタンをタップ（何も選択していない状態） | すべてのアイテムが選択される | ✅   |
| 2   | 「全選択」ボタンをタップ（一部選択している状態）   | すべてのアイテムが選択される | ✅   |
| 3   | 「全選択」ボタンをタップ（全選択済みの状態）       | すべての選択が解除される     | ✅   |

### 2. パスナビゲーション（Path）

#### 2.1 フォルダ移動

| #   | 操作                 | 期待結果                                 | 結果 |
| --- | -------------------- | ---------------------------------------- | ---- |
| 1   | フォルダをタップ     | そのフォルダ内に移動し、URL が更新される | ✅   |
| 2   | Header の ← をタップ | 親フォルダに移動し、URL が更新される     | ✅   |

#### 2.2 ブラウザ履歴との同期

| #   | 操作                                               | 期待結果                     | 結果 |
| --- | -------------------------------------------------- | ---------------------------- | ---- |
| 1   | フォルダを何階層か移動した後、ブラウザの戻るボタン | 前のフォルダに戻る           | ✅   |
| 2   | 戻った後にブラウザの進むボタン                     | 元のフォルダに進む           | ✅   |
| 3   | URL を直接編集してパスを変更                       | 指定したフォルダが表示される | ✅   |
| 4   | ページをリロード                                   | 現在のパスが維持される       | ✅   |

### 3. ソート機能（Sort）

#### 3.1 ソート順の変更

| #   | 操作                                 | 期待結果                               | 結果 |
| --- | ------------------------------------ | -------------------------------------- | ---- |
| 1   | ソートメニューから「名前順」を選択   | ファイルが名前順でソートされる         | ✅   |
| 2   | ソートメニューから「新しい順」を選択 | ファイルが更新日時の降順でソートされる | ✅   |
| 3   | ソートメニューから「古い順」を選択   | ファイルが更新日時の昇順でソートされる | ✅   |
| 4   | ソートメニューから「サイズ順」を選択 | ファイルがサイズ順でソートされる       | ✅   |

#### 3.2 ソート設定の永続化

| #   | 操作                                 | 期待結果                           | 結果 |
| --- | ------------------------------------ | ---------------------------------- | ---- |
| 1   | ソート設定を変更後、ページをリロード | 変更したソート設定が維持されている | ✅   |
| 2   | ソート設定を変更後、別タブで開く     | 変更したソート設定が反映されている | ✅   |
| 3   | localStorage を確認                  | ソート設定が保存されている         | ✅   |

### 4. ダイアログ機能（MoveDialog / RenameDialog）

#### 4.1 移動ダイアログ（MoveDialog）

| #   | 操作                                     | 期待結果                                     | 結果 |
| --- | ---------------------------------------- | -------------------------------------------- | ---- |
| 1   | ファイルを選択して「移動」をタップ       | 移動ダイアログが開き、ルートパスが表示される | ✅   |
| 2   | 移動先フォルダを選択して「移動」ボタン   | ファイルが移動し、ダイアログが閉じる         | ✅   |
| 3   | ダイアログを閉じて再度開く               | 状態がリセットされ、初期状態で表示される     | ✅   |
| 4   | 移動操作をキャンセル                     | ファイルは移動せず、ダイアログが閉じる       | ✅   |
| 5   | 移動先に同名ファイルが存在する状態で移動 | エラーメッセージが表示され、移動が中止される | ✅   |

#### 4.2 リネームダイアログ（RenameDialog）

| #   | 操作                                    | 期待結果                                                 | 結果 |
| --- | --------------------------------------- | -------------------------------------------------------- | ---- |
| 1   | ファイルを選択して「リネーム」をタップ  | リネームダイアログが開き、現在の名前が入力欄に表示される | ✅   |
| 2   | 新しい名前を入力して「リネーム」ボタン  | ファイル名が変更され、ダイアログが閉じる                 | ✅   |
| 3   | ダイアログを閉じて再度開く              | 状態がリセットされ、元の名前が表示される                 | ✅   |
| 4   | リネーム操作をキャンセル                | ファイル名は変更されず、ダイアログが閉じる               | ✅   |
| 5   | 既存のファイル/フォルダと同じ名前を入力 | エラーメッセージが表示され、リネームできない             | ✅   |

### 5. 複合操作シナリオ

#### 5.1 一括削除フロー

| #   | 操作                   | 期待結果                                         | 結果 |
| --- | ---------------------- | ------------------------------------------------ | ---- |
| 1   | 複数ファイルを選択     | 選択数が正しく表示される                         | ✅   |
| 2   | 「削除」ボタンをタップ | 削除確認ダイアログが表示される                   | ✅   |
| 3   | 削除を確定             | 選択したファイルが削除され、選択モードが終了する | ✅   |

#### 5.2 Lightbox プレビュー

| #   | 操作                                         | 期待結果                          | 結果 |
| --- | -------------------------------------------- | --------------------------------- | ---- |
| 1   | 画像ファイルをタップ（選択モードでない状態） | Lightbox でプレビューが表示される | ✅   |
| 2   | 左右スワイプ                                 | 前後の画像に切り替わる            | ✅   |
| 3   | 下スワイプ                                   | 元の一覧画面に戻る                | ✅   |

### 6. DevTools 検証

#### 6.1 状態変更の追跡

| #   | 確認事項                           | 期待結果                                              | 結果 |
| --- | ---------------------------------- | ----------------------------------------------------- | ---- |
| 1   | Jotai DevTools を開く              | 「Atom Viewer」タブで atoms の現在状態が表示される    |      |
| 2   | 選択操作を行う                     | 「Time Travel」タブに状態スナップショットが追加される |      |
| 3   | Time Travel でスナップショット選択 | スナップショットの内容（状態）が表示される            |      |
| 4   | Time Travel で再生ボタンを押す     | 最初から全スナップショットが順に再生される            |      |

> **Note**: Jotai DevTools は Redux DevTools と異なり、アクション名ではなく状態スナップショットを記録する。debugLabel は Atom Viewer での atom 識別に使用される。

#### 6.2 debugLabel の確認

| Atom                     | 期待される debugLabel     |
| ------------------------ | ------------------------- |
| currentPathAtom          | `path/current`            |
| isSelectionModeAtom      | `selection/mode`          |
| selectedKeysAtom         | `selection/keys`          |
| itemKeysAtom             | `selection/itemKeys`      |
| filteredSelectedKeysAtom | `selection/filteredKeys`  |
| isAllSelectedAtom        | `selection/isAllSelected` |
| sortOrderAtom            | `sort/order`              |
