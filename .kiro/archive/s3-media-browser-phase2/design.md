# Technical Design Document - Phase 2

## Overview

Phase 2 ã§ã¯ StorageBrowser ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç½®ãæ›ãˆã€ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‚’å®Ÿè£…ã™ã‚‹ã€‚ç”»åƒãƒ»å‹•ç”»ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€‚

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (React)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  App.tsx                                                     â”‚
â”‚  â”œâ”€â”€ Authenticator                                           â”‚
â”‚  â””â”€â”€ MediaBrowser (ã‚«ã‚¹ã‚¿ãƒ å®Ÿè£…)                              â”‚
â”‚       â”œâ”€â”€ Header (ã‚¢ãƒ—ãƒªåã€æˆ»ã‚‹ãƒœã‚¿ãƒ³ã€ã‚µã‚¤ãƒ³ã‚¢ã‚¦ãƒˆ)            â”‚
â”‚       â”œâ”€â”€ FileList (ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§)                              â”‚
â”‚       â”œâ”€â”€ FileActions (ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã€å‰Šé™¤)        â”‚
â”‚       â””â”€â”€ PreviewModal (ç”»åƒ/å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Amplify Backend                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Auth (Cognito)                                              â”‚
â”‚  Storage (S3)                                                â”‚
â”‚  â””â”€â”€ media/{entity_id}/                                      â”‚
â”‚       â””â”€â”€ *.jpg, *.png, *.mp4, ...                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Component Design

### 1. MediaBrowser ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ:**

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ MediaBrowser/
â”‚   â”‚   â”œâ”€â”€ index.tsx           # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ Header.tsx          # ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³å«ã‚€ï¼‰
â”‚   â”‚   â”œâ”€â”€ FileList.tsx        # ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
â”‚   â”‚   â”œâ”€â”€ FileItem.tsx        # å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«é …ç›®
â”‚   â”‚   â”œâ”€â”€ FileActions.tsx     # ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ç¾¤
â”‚   â”‚   â”œâ”€â”€ PreviewModal.tsx    # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
â”‚   â”‚   â””â”€â”€ CreateFolderDialog.tsx  # ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°
â”‚   â”‚   # FileUploader ã¯ Amplify UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç›´æ¥ä½¿ç”¨
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ Modal.tsx
â”‚       â”œâ”€â”€ Button.tsx
â”‚       â””â”€â”€ ...
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useStorage.ts           # Amplify Storage API ãƒ©ãƒƒãƒ‘ãƒ¼
â”‚   â””â”€â”€ useMediaPreview.ts      # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ç®¡ç†
â””â”€â”€ utils/
    â””â”€â”€ fileTypes.ts            # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—åˆ¤å®š
```

### 2. useStorage Hook

Amplify Storage API ã‚’ãƒ©ãƒƒãƒ—ã—ãŸã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ï¼š

```typescript
interface UseStorageReturn {
  items: StorageItem[];
  loading: boolean;
  error: Error | null;
  currentPath: string;
  navigate: (path: string) => void;
  upload: (files: File[]) => Promise<void>;
  remove: (key: string) => Promise<void>;
  createFolder: (name: string) => Promise<void>;
  refresh: () => void;
}

interface StorageItem {
  key: string;
  name: string;
  type: "file" | "folder";
  size?: number;
  lastModified?: Date;
}
```

### 3. PreviewModal ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

ç”»åƒãƒ»å‹•ç”»ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚’æ‹…å½“ã€‚å‹•ç”»å†ç”Ÿã«ã¯ `react-player` ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã€‚

```typescript
interface PreviewModalProps {
  isOpen: boolean;
  onClose: () => void;
  file: StorageItem | null;
  fileUrl: string | null;
}
```

#### ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆStorageImageï¼‰

```typescript
import { StorageImage } from '@aws-amplify/ui-react-storage';

<StorageImage
  path={file.key}  // presigned URL ã‚’å†…éƒ¨ã§è‡ªå‹•å–å¾—
  alt={file.name}
  style={{ maxWidth: '100%', maxHeight: '100%', objectFit: 'contain' }}
/>
```

- Amplify UI StorageImage ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨
- ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ å¯¾å¿œï¼ˆCSS `touch-action: pinch-zoom`ï¼‰
- ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ç¶­æŒã—ã¦ãƒ•ã‚£ãƒƒãƒˆ

#### å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆreact-playerï¼‰

```typescript
import ReactPlayer from 'react-player';

<ReactPlayer
  url={fileUrl}
  controls          // å†ç”Ÿã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡¨ç¤º
  playsinline       // iOS ã§ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³å†ç”Ÿ
  width="100%"
  height="auto"
  style={{ aspectRatio: '16/9' }}
  config={{
    file: {
      attributes: {
        controlsList: 'nodownload',  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³éè¡¨ç¤º
      }
    }
  }}
/>
```

**react-player ã®ç‰¹å¾´:**

- MP4, WebM, MOV ãªã©ä¸»è¦å½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆ
- `playsinline` ã§ãƒ¢ãƒã‚¤ãƒ« Safari ã®ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å¼·åˆ¶ã‚’å›é¿
- ãƒã‚¤ãƒ†ã‚£ãƒ– HTML5 ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå†ç”Ÿ/ä¸€æ™‚åœæ­¢ã€ã‚·ãƒ¼ã‚¯ã€éŸ³é‡ï¼‰
- ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œï¼ˆwidth: 100%ï¼‰

## Storage Path Structure

```
media/
â””â”€â”€ {entity_id}/           # Cognito Identity ID
    â”œâ”€â”€ folder1/
    â”‚   â”œâ”€â”€ image1.jpg
    â”‚   â””â”€â”€ image2.png
    â”œâ”€â”€ folder2/
    â”‚   â””â”€â”€ video1.mp4
    â””â”€â”€ photo.jpg
```

## API Design

### Amplify Storage API ä½¿ç”¨ä¾‹

```typescript
import { list, uploadData, remove, getUrl } from "aws-amplify/storage";

// ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§å–å¾—
const result = await list({
  path: "media/{entity_id}/",
  options: { listAll: true },
});

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
await uploadData({
  path: "media/{entity_id}/photo.jpg",
  data: file,
});

// ãƒ•ã‚¡ã‚¤ãƒ« URL å–å¾—ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
const url = await getUrl({
  path: "media/{entity_id}/photo.jpg",
});
```

## Authorization

### èªå¯æ–¹å¼

| æ“ä½œ           | API/ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ      | èªå¯æ–¹å¼                        |
| -------------- | ----------------------- | ------------------------------- |
| ä¸€è¦§å–å¾—       | `list`                  | Cognito Identity + IAM Policy   |
| ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ | StorageImage            | Presigned URLï¼ˆå†…éƒ¨ã§è‡ªå‹•å–å¾—ï¼‰ |
| å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ | `getUrl` â†’ react-player | Presigned URLï¼ˆ15åˆ†æœ‰åŠ¹ï¼‰       |
| ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰   | FileUploader            | Cognito Identity + IAM Policy   |
| å‰Šé™¤           | `remove`                | Cognito Identity + IAM Policy   |

### Presigned URL ã®ä½¿ç”¨ï¼ˆå‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰

å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«ã¯ `getUrl` ã§å–å¾—ã—ãŸ presigned URL ã‚’ react-player ã«æ¸¡ã™ï¼š

```typescript
const { url } = await getUrl({
  path: `media/{entity_id}/video.mp4`,
});
// url ã‚’ ReactPlayer ã® src ã«æ¸¡ã™
```

â€» ç”»åƒã¯ StorageImage ãŒå†…éƒ¨ã§ presigned URL ã‚’è‡ªå‹•å–å¾—ã™ã‚‹ãŸã‚ã€æ˜ç¤ºçš„ãª getUrl å‘¼ã³å‡ºã—ã¯ä¸è¦

## Security Considerations

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†é›¢**: `media/{entity_id}/` ãƒ‘ã‚¹ã§ IAM ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹åˆ†é›¢ã‚’ç¶­æŒ
2. **Presigned URL**: ä¸€æ™‚çš„ãªã‚¢ã‚¯ã‚»ã‚¹æ¨©ä»˜ä¸ï¼ˆ15åˆ†ã§å¤±åŠ¹ï¼‰

## Mobile-First Design

### è¨­è¨ˆæ–¹é‡

ãƒ¢ãƒã‚¤ãƒ«ï¼ˆã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ï¼‰ã§ã®æ“ä½œæ€§ã‚’æœ€å„ªå…ˆã¨ã—ã¦è¨­è¨ˆã™ã‚‹ã€‚ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã‚‚å‹•ä½œã™ã‚‹ãŒã€æœ€é©åŒ–ã®å¯¾è±¡ã¯ãƒ¢ãƒã‚¤ãƒ«ã®ã¿ã€‚

### ãƒ¢ãƒã‚¤ãƒ« UI è¦ä»¶

- **ã‚¿ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ**: æœ€å° 44x44pxï¼ˆæŒ‡ã§æŠ¼ã—ã‚„ã™ã„ã‚µã‚¤ã‚ºï¼‰
- **ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§**: ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å + ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
- **ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³**: ç”»é¢ä¸‹éƒ¨ã«å›ºå®šé…ç½®ï¼ˆFAB ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰
- **ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®å‰å¾Œç§»å‹•
- **ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥**: ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æ›´æ–°
- **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼**: é•·æŠ¼ã—ã¾ãŸã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‰Šé™¤ç­‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [â†] Header    [SignOut] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         â”‚
â”‚ FileList (ãƒªã‚¹ãƒˆè¡¨ç¤º)    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ image1.jpg       â‹® â”‚ â”‚
â”‚ â”‚ image2.png       â‹® â”‚ â”‚
â”‚ â”‚ folder1/         â†’ â”‚ â”‚
â”‚ â”‚ video1.mp4       â‹® â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     [+] Upload  [ğŸ“]    â”‚  â† FAB (Floating Action Button)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dependencies

### æ–°è¦è¿½åŠ 

```json
{
  "dependencies": {
    "@aws-amplify/ui-react": "^6.x",
    "@aws-amplify/ui-react-storage": "^3.x", // FileUploader
    "react-player": "^2.x" // å‹•ç”»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  }
}
```

## Testing Strategy

1. **Unit Tests**: hooksã€utils ã®ãƒ†ã‚¹ãƒˆ
2. **Component Tests**: Vitest + Testing Library
3. **E2E Tests**: Playwrightï¼ˆèªè¨¼ãƒ•ãƒ­ãƒ¼ã€ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œï¼‰
