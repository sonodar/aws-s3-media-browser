# Implementation Plan

## Tasks

#### 1. ストレージ操作フックにリネーム機能を追加
- [x] 1.0 (P) パス操作ユーティリティにリネームロジックを追加
  - `src/utils/pathUtils.ts` に実装（既存ファイルがあれば拡張、なければ新規作成）
  - 関数:
    - `buildRenamedKey(currentKey: string, newName: string): string`
      - 現在のキーから親パスを取得し、新しい名前と結合
      - 例: `photos/old.jpg` + `new.jpg` → `photos/new.jpg`
    - `buildRenamedPrefix(currentPrefix: string, newName: string): string`
      - フォルダプレフィックスのリネーム用
      - 例: `photos/old/` + `new` → `photos/new/`
    - `getParentPath(key: string): string`
      - 親ディレクトリパスを取得
      - 例: `photos/2024/image.jpg` → `photos/2024/`
  - ユニットテストも同時に作成（`src/utils/pathUtils.test.ts`）
  - _Requirements: 1.2, 2.2_

- [x] 1.1 単一ファイルのリネーム処理を実装
  - `pathUtils.buildRenamedKey()` を使用して新しいキーを生成
  - **S3 上での重複チェック**を実行直前に実施:
    - `list({ path: newKey })` で新キーの存在を確認
    - 存在する場合はエラー返却（「同じ名前のファイルが既に存在します」）
  - Amplify Storage の copy API を使用して新しいキーにコピー
  - コピー成功後に元のキーを remove で削除
  - 成功/失敗を示す結果オブジェクトを返却
  - コピー失敗時は元ファイルを維持してエラーを返却
  - 削除失敗時は成功扱いとしつつエラー情報を含めて返却
  - _Requirements: 1.2, 1.3, 4.1, 4.2_

- [x] 1.2 フォルダのリネーム処理を実装
  - `pathUtils.buildRenamedPrefix()` を使用して新しいプレフィックスを生成
  - **ファイル数制限チェック**:
    - `MAX_FOLDER_RENAME_ITEMS = 1000`
    - 配下オブジェクト数が 1000 件超の場合はエラー返却
    - エラーメッセージ: 「フォルダ内のファイル数が多すぎます（{count}件）。1000件以下のフォルダのみリネーム可能です」
  - **最適化された事前重複チェック**を copy 開始前に実施:
    - 先にリネーム先プレフィックス配下の既存オブジェクト一覧を取得（Set で保持）
    - リネーム先が空の場合は重複チェックをスキップ（高速パス）
    - 元フォルダ配下のオブジェクト一覧を取得
    - 各ソースオブジェクトの新キーを Set.has() で O(1) チェック
    - **1件でも重複があればリネーム全体を中止**（部分実行しない）
    - 重複ファイル一覧をエラーメッセージに含める
  - 重複がなければ処理続行:
    - 各オブジェクトを新しいプレフィックスにコピー
    - 進捗コールバックで処理済み/総数を通知
    - コピー成功したオブジェクトのみ元キーを削除
  - 成功・失敗を分類した結果オブジェクトを返却
  - _Requirements: 2.2, 2.3, 2.5, 4.3, 4.4_

- [x] 1.3 リネーム処理の状態管理を追加
  - isRenaming フラグを追加して処理中状態を管理
  - リネーム完了後に fetchItems を呼び出して一覧を更新
  - _Requirements: 1.4, 2.5_

#### 2. リネームダイアログコンポーネントを作成
- [x] 2.1 (P) validateRename 関数を独立ユーティリティとして実装
  - `src/utils/validateRename.ts` に実装
  - 入力: `{ newName, item, existingItems }` → 出力: `{ valid, error?, normalizedName? }`
  - **2層バリデーションの UI 層**（形式チェック + 重複チェック for early return）
  - バリデーションルール（優先度順）:
    1. 空文字チェック: `newName.trim() === ''` → 「名前を入力してください」
    2. 無効文字チェック: `/` or `\\` 含む → 「名前にスラッシュは使用できません」
    3. 長さ制限: `> 100文字` → 「名前は100文字以内にしてください」
    4. 同一名チェック: `newName.trim() === item.name` → 「名前が変更されていません」
    5. 重複チェック（UI）: `existingItems` に同タイプ同名が存在 → 「同じ名前の{ファイル/フォルダ}が既に存在します」
  - 重複チェックの詳細:
    - 比較対象: `existingItems.filter(i => i.type === item.type && i.key !== item.key)`
    - 比較方法: case-sensitive
  - 成功時は `normalizedName`（トリム済み）を返却
  - **注意**: UI 重複チェックは UX 向上のための early return。データ安全性はフック層の S3 API チェックで保証
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 2.2 リネームダイアログの UI を実装
  - 既存の CreateFolderDialog のスタイルを再利用
  - 現在の名前をデフォルト値として入力フィールドに設定
  - 入力フィールドにオートフォーカスを設定
  - ファイル/フォルダに応じたダイアログタイトルを表示
  - バリデーションエラーメッセージを表示
  - _Requirements: 1.1, 2.1, 5.2, 5.3_

- [x] 2.3 ダイアログの操作ハンドリングを実装
  - Enter キーでリネーム確定
  - Escape キーでキャンセル
  - キャンセルボタンでダイアログを閉じる
  - 確定ボタンでリネーム処理を実行
  - 処理中は入力とボタンを無効化
  - _Requirements: 1.5, 5.4_

- [x] 2.4 フォルダリネーム時の進捗表示を実装
  - 処理済み件数と総件数を表示
  - プログレスバーまたはテキストで進捗を可視化
  - _Requirements: 2.4_

#### 3. ファイル一覧にリネームアクションを追加
- [x] 3.1 各アイテムにリネームボタンを追加
  - ファイル・フォルダの行にリネームアイコンボタンを配置
  - クリック時に onRename コールバックを呼び出し
  - 選択モード中はボタンを非表示
  - _Requirements: 5.1_

- [x] 3.2 MediaBrowser にリネーム状態管理を追加
  - `renameTarget: StorageItem | null` 状態を追加
  - リネームダイアログの表示/非表示を `renameTarget !== null` で制御
  - RenameDialog へ props を渡す:
    - `item={renameTarget}`
    - `onRename` ハンドラ（type に応じて renameItem/renameFolder を呼び分け）
  - リネーム実行時にフックのメソッドを呼び出し
  - **フック層から返されたエラー（S3 重複等）をダイアログに表示**
  - 完了後に `renameTarget` を null にしてダイアログを閉じる
  - _Requirements: 1.1, 1.3, 2.1, 2.5_

#### 4. エラーハンドリングとユーザー通知を実装
- [x] 4.1 リネーム失敗時のエラー表示
  - コピー失敗時はダイアログ内にエラーメッセージを表示
  - ネットワークエラー時はリトライ可能であることを通知
  - 削除失敗時は新旧両方のファイルが存在することを通知
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 4.2 フォルダリネームの部分失敗時の結果表示
  - 成功・失敗件数のサマリーを表示
  - 失敗したファイルの一覧を表示
  - _Requirements: 4.4_

#### 5. テストを実装
- [x] 5.1 (P) validateRename 関数のユニットテスト
  - `src/utils/validateRename.test.ts` に実装
  - **UI 層バリデーション**（形式チェック + UI 重複チェック）
  - テストケース（形式チェック）:
    - 空文字 `""` → エラー
    - 空白のみ `"   "` → エラー
    - スラッシュ含む `"foo/bar"` → エラー
    - バックスラッシュ含む `"foo\\bar"` → エラー
    - 101文字 → エラー（100文字は OK）
    - 同一名（変更なし） → エラー
    - 前後空白 → OK（normalizedName でトリム済み）
    - 拡張子変更 → OK
    - 正常な名前 → OK
  - テストケース（UI 重複チェック）:
    - ファイル重複（UI）: 既存ファイル名 → エラー
    - フォルダ重複（UI）: 既存フォルダ名 → エラー
    - 異タイプ同名: ファイル→既存フォルダ名 → OK（同タイプのみチェック）
    - 大文字小文字違い: `"Photo.jpg"` vs `"photo.jpg"` → OK（case-sensitive）
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 5.2 リネーム処理のユニットテスト
  - **S3 重複チェックのテスト**:
    - 新キーが存在しない場合 → リネーム成功
    - 新キーが既存ファイルと重複 → エラー返却（コピー実行されない）
    - list API エラー時 → 安全側に倒してエラー返却
  - **フォルダリネーム事前チェックのテスト**:
    - ファイル数 1001件以上 → エラー返却（「ファイル数が多すぎます」）
    - ファイル数 1000件以下 → 処理続行
    - リネーム先が空 → 重複チェックスキップ（高速パス）
    - 1件でも重複あり → リネーム全体を中止（部分実行なし）
    - 重複ファイル一覧がエラーに含まれることを確認
  - copy → remove の正常フローをテスト
  - コピー失敗時の元ファイル維持を確認
  - 削除失敗時のエラー情報を確認
  - フォルダリネーム時の複数ファイル処理をテスト
  - 進捗コールバックの呼び出しを確認
  - _Requirements: 1.2, 2.2, 2.3, 3.2, 4.1, 4.2, 4.3, 4.4_

- [x] 5.3 RenameDialog のコンポーネントテスト
  - 初期表示と入力フィールドのデフォルト値を確認
  - バリデーションエラーの表示を確認
  - Enter/Escape キー操作の動作を確認
  - 処理中の無効化状態を確認
  - _Requirements: 1.1, 1.4, 1.5, 3.1, 5.2, 5.3, 5.4_

#### 6. オプション: 追加のリネームアクセスポイント
- [x]* 6.1 (P) PreviewModal にリネームボタンを追加
  - プレビュー画面のヘッダーまたはアクションエリアにリネームボタンを配置
  - クリック時にプレビューを閉じてリネームダイアログを表示
  - FileList からのリネームと同じフローを再利用
  - _Requirements: 5.1_

#### 7. ユーザーテスト（手動テスト）

##### 前提条件
- 開発サーバーが起動していること（`npm run dev`）
- ログイン済みであること
- テスト用のファイルとフォルダがS3にアップロード済みであること

##### テストケース

**A. ファイルリネーム - 正常系**
- [ ] A.1 ファイル一覧からファイルをリネーム
  - 手順: ファイル行の✏️ボタンをクリック → 新しい名前を入力 → 「変更」ボタンをクリック
  - 期待結果: ダイアログが閉じ、一覧に新しい名前で表示される
- [ ] A.2 拡張子を変更してリネーム
  - 手順: `image.jpg` を `image.png` にリネーム
  - 期待結果: 拡張子が変更された状態で一覧に表示される
- [ ] A.3 プレビュー画面からファイルをリネーム
  - 手順: ファイルをクリックしてプレビュー表示 → ✏️ボタンをクリック → 新しい名前を入力 → 「変更」
  - 期待結果: プレビューが閉じ、リネームダイアログが表示され、リネーム後に一覧が更新される

**B. ファイルリネーム - バリデーション**
- [ ] B.1 空文字でリネーム試行
  - 手順: 名前を空にして「変更」をクリック
  - 期待結果: 「名前を入力してください」エラーが表示される
- [ ] B.2 スラッシュを含む名前でリネーム試行
  - 手順: `foo/bar.jpg` と入力して「変更」をクリック
  - 期待結果: 「名前にスラッシュは使用できません」エラーが表示される
- [ ] B.3 バックスラッシュを含む名前でリネーム試行
  - 手順: `foo\bar.jpg` と入力して「変更」をクリック
  - 期待結果: 「名前にスラッシュは使用できません」エラーが表示される
- [ ] B.4 101文字以上の名前でリネーム試行
  - 手順: 101文字の名前を入力して「変更」をクリック
  - 期待結果: 「名前は100文字以内にしてください」エラーが表示される
- [ ] B.5 同じ名前でリネーム試行
  - 手順: 現在と同じ名前のまま「変更」をクリック
  - 期待結果: 「名前が変更されていません」エラーが表示される
- [ ] B.6 既存ファイルと同じ名前でリネーム試行（UI重複チェック）
  - 手順: 同じフォルダ内の別ファイルと同じ名前を入力して「変更」をクリック
  - 期待結果: 「同じ名前のファイルが既に存在します」エラーが表示される

**C. フォルダリネーム - 正常系**
- [ ] C.1 空フォルダをリネーム
  - 手順: 空のフォルダの✏️ボタンをクリック → 新しい名前を入力 → 「変更」
  - 期待結果: フォルダ名が変更され、一覧に新しい名前で表示される
- [ ] C.2 ファイルを含むフォルダをリネーム
  - 手順: 複数ファイルを含むフォルダをリネーム
  - 期待結果: 進捗表示（X / Y 件処理中...）が表示され、完了後にフォルダ名が変更される
- [ ] C.3 ネストしたフォルダをリネーム
  - 手順: サブフォルダを持つフォルダをリネーム
  - 期待結果: サブフォルダ構造が維持されたままリネームされる

**D. フォルダリネーム - 異常系**
- [ ] D.1 既存フォルダと同じ名前でリネーム試行（UI重複チェック）
  - 手順: 同じ階層の別フォルダと同じ名前を入力
  - 期待結果: 「同じ名前のフォルダが既に存在します」エラーが表示される
- [ ] D.2 リネーム先に重複ファイルが存在する場合（S3重複チェック）
  - 前提: リネーム先のフォルダ名と同じ名前のフォルダが既に存在し、中に同名ファイルがある
  - 手順: フォルダをリネーム試行
  - 期待結果: 重複ファイル一覧がエラーメッセージに表示され、リネームが中止される

**E. ダイアログ操作**
- [ ] E.1 Enterキーでリネーム確定
  - 手順: 新しい名前を入力 → Enterキーを押下
  - 期待結果: リネームが実行される
- [ ] E.2 Escapeキーでキャンセル
  - 手順: ダイアログ表示中にEscapeキーを押下
  - 期待結果: ダイアログが閉じ、リネームは実行されない
- [ ] E.3 キャンセルボタンでキャンセル
  - 手順: 「キャンセル」ボタンをクリック
  - 期待結果: ダイアログが閉じ、リネームは実行されない
- [ ] E.4 バックドロップクリックでキャンセル
  - 手順: ダイアログ外の暗い部分をクリック
  - 期待結果: ダイアログが閉じ、リネームは実行されない
- [ ] E.5 処理中のUI無効化
  - 手順: リネーム実行中に入力フィールドやボタンを操作
  - 期待結果: 処理中は入力フィールドとボタンが無効化されている
- [ ] E.6 オートフォーカス確認
  - 手順: リネームダイアログを開く
  - 期待結果: 入力フィールドにフォーカスが当たっている

**F. 選択モードとの連携**
- [ ] F.1 選択モード中はリネームボタン非表示
  - 手順: 「選択」ボタンをクリックして選択モードに入る
  - 期待結果: 各アイテムのリネームボタン（✏️）が非表示になる

**G. エラーからの復帰**
- [ ] G.1 バリデーションエラー後に正しい名前で再試行
  - 手順: 無効な名前を入力してエラー表示 → 正しい名前に修正 → 「変更」をクリック
  - 期待結果: リネームが正常に実行される

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 2.2, 3.2, 5.3 |
| 1.2 | 1.0, 1.1, 5.2 |
| 1.3 | 1.1, 3.2 |
| 1.4 | 1.3, 5.3 |
| 1.5 | 2.3, 5.3 |
| 2.1 | 2.2, 3.2 |
| 2.2 | 1.0, 1.2, 5.2 |
| 2.3 | 1.2, 5.2 |
| 2.4 | 2.4 |
| 2.5 | 1.2, 1.3, 3.2 |
| 3.1 | 2.1, 5.1 |
| 3.2 | 2.1, 5.1, 1.1, 1.2, 5.2 |
| 3.3 | 2.1, 5.1 |
| 3.4 | 2.1, 5.1 |
| 4.1 | 1.1, 4.1, 5.2 |
| 4.2 | 1.1, 4.1, 5.2 |
| 4.3 | 1.2, 4.1 |
| 4.4 | 1.2, 4.2, 5.2 |
| 5.1 | 3.1 |
| 5.2 | 2.2, 5.3 |
| 5.3 | 2.2, 5.3 |
| 5.4 | 2.3, 5.3 |
