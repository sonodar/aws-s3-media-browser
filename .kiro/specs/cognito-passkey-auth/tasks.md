# Implementation Plan

## Task 1: バックエンド認証設定

- [x] 1.1 WebAuthn 認証を有効化するバックエンド設定を実装する
  - `defineAuth` の `loginWith.webAuthn` オプションでパスキー認証を有効化する
  - 環境変数 `WEBAUTHN_RELYING_PARTY_ID` から RelyingPartyID を取得する
  - 環境変数未設定時は Amplify デフォルト動作にフォールバックする
  - `userVerification` を `preferred` に設定する
  - 既存のメール認証設定（`loginWith.email: true`）を維持する
  - 既存のセルフサインアップ無効化設定（`allowAdminCreateUserOnly: true`）を維持する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 5.4, 7.2, 7.4_

## Task 2: WebAuthn サポート検出機能

- [x] 2.1 (P) ブラウザの WebAuthn サポート状況を検出する Hook を実装する
  - `window.PublicKeyCredential` の存在をチェックする
  - `isUserVerifyingPlatformAuthenticatorAvailable()` でプラットフォーム認証器の利用可否を確認する
  - サポート状況を `isSupported` として返す
  - _Requirements: 6.4_

## Task 3: パスキー管理 Hook

- [x] 3.1 パスキー一覧取得機能を実装する
  - `listWebAuthnCredentials()` API を呼び出してパスキー一覧を取得する
  - ページネーション対応（`nextToken` を使用して追加データを取得）
  - パスキー情報（credentialId, friendlyCredentialName, createdAt）を返す
  - ローディング状態とエラー状態を管理する
  - _Requirements: 3.1, 3.2, 3.7_

- [x] 3.2 パスキー登録機能を実装する
  - `associateWebAuthnCredential()` API を呼び出してパスキー登録フローを開始する
  - 登録中のローディング状態を管理する
  - 登録成功時にパスキー一覧を更新する
  - 登録失敗時にエラーを返す
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 7.1_

- [x] 3.3 パスキー削除機能を実装する
  - `deleteWebAuthnCredential()` API を呼び出してパスキーを削除する
  - 削除成功時にパスキー一覧から該当項目を除去する
  - 削除失敗時にエラーを返す
  - _Requirements: 3.4, 3.5, 3.6, 7.1_

## Task 4: パスキーサインイン UI

- [x] 4.1 パスキーサインインコンポーネントを実装する
  - メールアドレス入力フィールドを提供する
  - パスキーでサインインボタンを実装する
  - `signIn()` API を `authFlowType: 'USER_AUTH'` と `preferredChallenge: 'WEB_AUTHN'` で呼び出す
  - サインイン成功時（`nextStep.signInStep` が `'DONE'`）にコールバックを実行する
  - サインイン失敗時にエラーメッセージを表示する
  - パスワード認証への切り替えリンクを提供する
  - ローディング状態を表示する
  - 詳細なエラー情報を外部に公開しない
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 6.3, 7.3_

- [x] 4.2 (P) パスキーサインインのスタイルを実装する
  - Amplify UI のスタイルと一貫したデザインを適用する
  - `@aws-amplify/ui-react` のコンポーネントを活用する
  - _Requirements: 6.1, 6.5_

## Task 5: パスキー管理 UI

- [x] 5.1 パスキー管理コンポーネントを実装する
  - パスキー登録ボタンを実装する
  - 登録済みパスキー一覧を表示する（パスキー名、作成日時）
  - 各パスキーに削除ボタンを配置する
  - ローディング状態とエラー状態を表示する
  - WebAuthn 非サポートブラウザでは機能を非表示にする
  - 未認証状態ではパスキー登録機能を非表示にする
  - _Requirements: 2.4, 3.1, 3.2, 3.3, 6.3, 6.4_

- [x] 5.2 パスキー削除確認ダイアログを実装する
  - 削除ボタンクリック時に確認ダイアログを表示する
  - ユーザーが確認後に削除を実行する
  - _Requirements: 3.3, 3.4_

- [x] 5.3 (P) パスキー管理のスタイルを実装する
  - Amplify UI の Card, Button, Loader などのコンポーネントを活用する
  - 既存 UI との一貫性を維持する
  - _Requirements: 6.1, 6.5_

## Task 6: パスキー設定モーダル

- [x] 6.1 パスキー設定モーダルコンポーネントを実装する
  - モーダルオーバーレイを実装する
  - モーダルヘッダー（タイトル + 閉じるボタン）を配置する
  - パスキー管理コンポーネントをモーダル内に表示する
  - 開閉状態を Props で制御する
  - _Requirements: 6.2_

- [x] 6.2 (P) パスキー設定モーダルのスタイルを実装する
  - 既存の削除確認ダイアログと一貫したデザインを適用する
  - _Requirements: 6.1_

## Task 7: Header への設定ボタン追加

- [x] 7.1 Header コンポーネントに設定ボタンを追加する
  - header-right セクションに設定ボタンを追加する
  - 設定ボタンクリック時にコールバックを実行する
  - 既存のレイアウトを維持する
  - _Requirements: 6.2_

## Task 8: ハイブリッド認証 UI の統合

- [x] 8.1 App.tsx にハイブリッド認証 UI を統合する
  - 認証モード状態（パスキー / パスワード）を管理する
  - パスキーサインインオプションを表示する
  - パスワード認証への切り替え機能を実装する
  - パスキーサインイン成功時に MediaBrowser を表示する
  - パスワード認証時は既存の Authenticator コンポーネントを使用する
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 8.2 MediaBrowser にパスキー設定モーダルを統合する
  - Header の設定ボタンクリックでモーダルを開く
  - モーダルの開閉状態を管理する
  - _Requirements: 6.2_

## Task 9: 統合テスト

- [ ]\* 9.1 パスキー機能の動作確認を行う
  - バックエンド設定のデプロイと動作確認
  - パスキー登録フローのテスト
  - パスキーサインインフローのテスト
  - パスキー削除フローのテスト
  - パスワード認証との切り替えテスト
  - WebAuthn 非サポートブラウザでの動作確認
  - _Requirements: 1.1, 2.1, 3.1, 4.1, 5.1, 6.4, 7.1_

## Requirements Coverage

| Requirement | Tasks         |
| ----------- | ------------- |
| 1.1         | 1.1           |
| 1.2         | 1.1           |
| 1.3         | 1.1           |
| 1.4         | 1.1           |
| 1.5         | 1.1           |
| 1.6         | 1.1           |
| 2.1         | 3.2           |
| 2.2         | 3.2           |
| 2.3         | 3.2           |
| 2.4         | 5.1           |
| 2.5         | 3.2           |
| 3.1         | 3.1, 5.1      |
| 3.2         | 3.1, 5.1      |
| 3.3         | 5.1, 5.2      |
| 3.4         | 3.3, 5.2      |
| 3.5         | 3.3           |
| 3.6         | 3.3           |
| 3.7         | 3.1           |
| 4.1         | 4.1           |
| 4.2         | 4.1           |
| 4.3         | 4.1           |
| 4.4         | 4.1           |
| 4.5         | 4.1           |
| 5.1         | 8.1           |
| 5.2         | 8.1           |
| 5.3         | 8.1           |
| 5.4         | 1.1           |
| 6.1         | 4.2, 5.3, 6.2 |
| 6.2         | 6.1, 7.1, 8.2 |
| 6.3         | 4.1, 5.1      |
| 6.4         | 2.1, 5.1, 9.1 |
| 6.5         | 4.2, 5.3      |
| 7.1         | 3.2, 3.3, 9.1 |
| 7.2         | 1.1           |
| 7.3         | 4.1           |
| 7.4         | 1.1           |
