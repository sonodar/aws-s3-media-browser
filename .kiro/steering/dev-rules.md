# Development Rules

## 本質志向（最重要）

**実装前に必ず確認すること：**

1. **目的の理解**: この作業は何のためにあるのか？ユーザー/システムにどんな価値を提供するのか？
2. **背景の把握**: なぜこの要件が生まれたのか？どんな課題や制約から導かれたのか？
3. **対症療法の回避**: 要件や指示を「満たすだけ」の実装になっていないか？根本的な解決になっているか？

### 自問すべき質問

- [ ] 「指示を満たすこと」ではなく「問題を解決すること」に集中しているか？
- [ ] この実装は将来の類似問題も防げるか、それとも今回限りの応急処置か？
- [ ] 要件の文言に囚われず、要件が生まれた背景に沿った実装になっているか？
- [ ] もし要件の記載が曖昧・不完全だった場合、背景から推論して適切に補完もしくは質問できているか？

### 危険信号

以下に該当する場合は、対症療法的な実装の可能性が高い：

- 「とりあえず動く」ことだけを目指している
- 要件に書かれていることだけを機械的に実装している
- なぜその実装が正しいのか説明できない
- 同じパターンの問題が別の場所で再発しそう

---

## 実装ルール（必須）

- サブタスクでテストを実装する前に、必ず前回実装したテストの内容を参考にすること
- サブタスク完了時は必ず `npm run check` を行うこと（npm run check: typecheck, lint, test の並列実行）
- タスク（サブタスクではなくタスク）完了時は必ず `npm run check-all` を行うこと (check-all: check + format + build)
- 各タスク完了後は必ずユーザーに報告し、次のタスクに進む前に明示的な指示を待つこと
- 差分確認のため、ユーザーの許可なく次のタスクを自動的に開始しないこと
- タスク完了時は変更点のサマリーを提示すること

## タスク管理（必須）

**TodoWrite ツールを必ず使用する**。タスクの進捗を可視化し、検証ステップの漏れを防ぐ。

### 使用ルール

1. **作業開始時**: tasks.md のサブタスクを TodoWrite に登録
2. **検証を独立項目に**: 各サブタスクの後に `npm run check` を独立した todo として追加
3. **リアルタイム更新**: 完了したら即座に `completed` に更新（バッチ更新禁止）
4. **セッション継続時**: 前回の todo 状態を確認し、必要に応じて再登録

### 登録例

```
- [ ] Task 2.1: identityIdAtom の実装
- [ ] npm run check（Task 2.1）  ← 検証を独立項目に
- [ ] Task 2.2: useIdentityId の置き換え
- [ ] npm run check（Task 2.2）
- [ ] npm run check-all（Task 2 完了時）  ← タスク完了時は check-all
```

## 検証コマンド（必須）

実装時は以下のコマンドで検証すること。`npm run test` 単体での確認は不十分（TypeScript エラーを検出しない）。

| タイミング       | コマンド            | 内容                         |
| ---------------- | ------------------- | ---------------------------- |
| サブタスク完了時 | `npm run check`     | typecheck + lint + test 並列 |
| タスク完了時     | `npm run check-all` | check + format + build       |

### 理由

- `npm run test`（vitest）は esbuild でトランスパイルするため、TypeScript の型エラーを検出しない
- `npm run check` は `tsc --noEmit` を含むため、型エラーを確実に検出する

## セッション継続時の注意

コンテキスト継続（compaction 後）時は、前回セッションのパターンを引き継がず、必ず以下を確認すること：

1. dev-rules.md の「実装ルール」セクションを再読
2. 上記の検証コマンドを確実に実行
3. 前回セッションで `npm run test` のみ実行していた場合でも、`npm run check` に切り替える

---

## 禁止コマンド

- `grep` ではなく `rg` または `Search` ツールを使ってください
- `find` ではなく `fd` または `Find` ツールを使ってください

_This document ensures consistent quality gates across all implementation sessions_
